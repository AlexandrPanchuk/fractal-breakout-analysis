<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fractal Breakout Analysis</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            color: #e4e4e7;
            line-height: 1.6;
        }
        
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            padding: 24px;
        }
        
        .header { 
            text-align: center; 
            margin-bottom: 40px;
            padding: 32px 0;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 1.1rem;
            color: #a1a1aa;
        }
        
        .current-fractals {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 32px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .current-fractals h3 {
            font-size: 1.25rem;
            margin-bottom: 20px;
            color: #f4f4f5;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .timeframe-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }
        
        .timeframe-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #a1a1aa;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .timeframe-tab.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border-color: #3b82f6;
        }
        
        .timeframe-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .fractal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }
        
        .fractal-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .fractal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .fractal-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.25);
        }
        
        .fractal-card:hover::before {
            opacity: 1;
        }
        
        .fractal-pair {
            font-size: 1.25rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 12px;
        }
        
        .fractal-price {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #f4f4f5;
        }
        
        .fractal-levels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .fractal-level {
            background: rgba(255, 255, 255, 0.05);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            border-left: 3px solid transparent;
        }
        
        .fractal-high {
            border-left-color: #10b981;
        }
        
        .fractal-low {
            border-left-color: #ef4444;
        }
        
        .distance {
            font-size: 0.875rem;
            color: #a1a1aa;
            margin-top: 4px;
        }
        
        .distance.close {
            color: #f59e0b;
            font-weight: 600;
        }
        
        .distance.very-close {
            color: #ef4444;
            font-weight: 700;
            animation: pulse 2s infinite;
        }
        
        .distance.broken {
            color: #6b7280;
            text-decoration: line-through;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
            padding: 24px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #f4f4f5;
            font-size: 0.875rem;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #f4f4f5;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        

        
        .reaction-item.yesterday-low {
            background: rgba(255, 165, 0, 0.1);
            border-left-color: #ffa500;
            box-shadow: 0 0 10px rgba(255, 165, 0, 0.3);
        }
        
        .yesterday-low-badge {
            background: #ffa500;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 8px;
        }
        
        .alert-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 1000;
            max-width: 400px;
        }
        
        .alert-item {
            background: rgba(239, 68, 68, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            animation: slideIn 0.5s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .alert-proximity {
            background: rgba(245, 158, 11, 0.95);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(20px);
            margin: 2% auto;
            padding: 32px;
            border-radius: 16px;
            width: 90%;
            max-width: 1200px;
            max-height: 90%;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-title {
            color: #3b82f6;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .close-btn {
            color: #a1a1aa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .close-btn:hover {
            color: #f4f4f5;
        }
        
        .modal-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #a1a1aa;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .modal-tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        
        .modal-tab:hover:not(.active) {
            color: #f4f4f5;
        }
        
        .loading {
            color: #a1a1aa;
            font-style: italic;
            text-align: center;
            padding: 40px;
        }
        
        .news-indicator {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #f59e0b;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .news-indicator.high {
            background: #ef4444;
        }
        
        .fractal-status {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 12px;
            margin-left: 6px;
            font-weight: 600;
        }
        
        .fractal-status.active {
            background: #10b981;
            color: white;
        }
        
        .fractal-status.broken {
            background: #6b7280;
            color: #d1d5db;
        }
        
        .forex-calendar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 32px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        .todays-events,
        .upcoming-events {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
        }
        
        .event-item {
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 12px;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        
        .event-high { border-left-color: #ef4444; }
        .event-medium { border-left-color: #f59e0b; }
        .event-low { border-left-color: #10b981; }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .event-title {
            font-weight: 600;
            color: #f4f4f5;
        }
        
        .event-impact {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .impact-high { background: #ef4444; color: white; }
        .impact-medium { background: #f59e0b; color: white; }
        .impact-low { background: #10b981; color: white; }
        
        .event-details {
            font-size: 0.875rem;
            color: #a1a1aa;
        }
        
        .event-time {
            color: #3b82f6;
            font-weight: 600;
        }
        
        .event-currency {
            background: #6b7280;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }
        

        
        .pair-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .pair-stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .pair-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #10b981;
        }
        
        .pair-stat-label {
            color: #a1a1aa;
            font-size: 0.875rem;
        }
        
        .events-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .events-table th,
        .events-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .events-table th {
            background: rgba(255, 255, 255, 0.05);
            color: #3b82f6;
        }
        
        .news-details {
            margin-top: 12px;
            padding: 8px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .news-details.high {
            background: rgba(239, 68, 68, 0.1);
        }
        
        .multi-levels {
            margin-top: 12px;
            font-size: 0.75rem;
        }
        
        .multi-level {
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 8px;
            margin: 2px 0;
            border-radius: 4px;
        }
        
        .multi-level.broken {
            opacity: 0.6;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: rgba(0, 0, 0, 0.9);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 11px;
            line-height: 1.4;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        @keyframes newsGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(245, 158, 11, 0.5); }
            50% { box-shadow: 0 0 25px rgba(245, 158, 11, 0.8); }
        }
        
        @keyframes highImpactGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 30px rgba(239, 68, 68, 1); }
        }
        
        .fractal-card.news-impact {
            border: 2px solid #f59e0b;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
            animation: newsGlow 2s infinite;
        }
        
        .fractal-card.high-impact {
            border: 2px solid #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.7);
            animation: highImpactGlow 1.5s infinite;
        }
        
        /* Trade Journal Styles */
        .journal-container {
            display: none;
        }
        
        .journal-container.active {
            display: block;
        }
        
        .reactions-list {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 32px;
        }
        
        .reactions-list h3 {
            margin-bottom: 20px;
            color: #3b82f6;
            font-size: 1.125rem;
        }
        
        .reaction-item {
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 21px;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        
        .reaction-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .reaction-pair {
            font-weight: 700;
            color: #3b82f6;
        }
        
        .reaction-type {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .type-high { background: #10b981; }
        .type-low { background: #ef4444; }
        
        .reaction-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            font-size: 0.875rem;
        }
        
        .metric {
            text-align: center;
        }
        
        .metric-label {
            color: #a1a1aa;
            font-size: 0.75rem;
        }
        
        .metric-value {
            font-weight: 700;
        }
        
        .journal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .journal-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #10b981;
        }
        
        .stat-label {
            color: #a1a1aa;
            font-size: 0.875rem;
        }
        
        .journal-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .journal-tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #a1a1aa;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .journal-tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        
        .trade-form {
            background: rgba(255, 255, 255, 0.05);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #f4f4f5;
            font-size: 0.875rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #f4f4f5;
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .trades-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .trades-table th,
        .trades-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .trades-table th {
            background: rgba(255, 255, 255, 0.1);
            color: #3b82f6;
            font-weight: 600;
        }
        
        .trade-direction {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .direction-long {
            background: #10b981;
            color: white;
        }
        
        .direction-short {
            background: #ef4444;
            color: white;
        }
        
        .pnl-positive {
            color: #10b981;
            font-weight: 600;
        }
        
        .pnl-negative {
            color: #ef4444;
            font-weight: 600;
        }
        
        .trade-outcome {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .outcome-tp {
            background: #10b981;
            color: white;
        }
        
        .outcome-sl {
            background: #ef4444;
            color: white;
        }
        
        .outcome-manual {
            background: #f59e0b;
            color: white;
        }
        
        .journal-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .fractal-grid {
                grid-template-columns: 1fr;
            }
            

            
            .calendar-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .journal-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Fractal Breakout Analysis</h1>
            <p>Real-time fractal monitoring with multi-timeframe analysis</p>
        </div>

        <div class="current-fractals">
            
            <div class="timeframe-tabs">
                <button class="timeframe-tab active" onclick="switchTimeframe('daily')">Daily</button>
                <button class="timeframe-tab" onclick="switchTimeframe('weekly')">Weekly</button>
                <button class="timeframe-tab" onclick="switchTimeframe('monthly')">Monthly</button>
                <button class="timeframe-tab" onclick="switchTimeframe('journal')">Trade Journal</button>
                <span id="momentumIndicator" style="font-size: 0.875rem; color: #f59e0b; margin-left: auto;">Loading...</span>
            </div>
            <div id="fractalGrid" class="fractal-grid">
                <p class="loading">Loading current fractals...</p>
            </div>
            
            <!-- Trade Journal Container -->
            <div id="journalContainer" class="journal-container">
                <div class="journal-header">
                    <h3>üìä Trade Journal</h3>
                    <button class="btn" onclick="openTradeForm()">+ New Trade</button>
                </div>
                
                <div class="journal-stats" id="journalStats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalTrades">0</div>
                        <div class="stat-label">Total Trades</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="winRate">0%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgR">0.0</div>
                        <div class="stat-label">Avg R</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="expectancy">0.0</div>
                        <div class="stat-label">Expectancy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="profitFactor">0.0</div>
                        <div class="stat-label">Profit Factor</div>
                    </div>
                </div>
                
                <div class="journal-tabs">
                    <div class="journal-tab active" onclick="switchJournalTab('open')">Open Trades</div>
                    <div class="journal-tab" onclick="switchJournalTab('closed')">Journal</div>
                    <div class="journal-tab" onclick="switchJournalTab('stats')">Statistics</div>
                </div>
                
                <div id="openTradesTab" class="tab-content active">
                    <div id="openTradesContent">
                        <p class="loading">Loading open trades...</p>
                    </div>
                </div>
                
                <div id="closedTradesTab" class="tab-content">
                    <div class="journal-filters">
                        <select id="ideaFilter">
                            <option value="">All Ideas</option>
                        </select>
                        <select id="directionFilter">
                            <option value="">All Directions</option>
                            <option value="LONG">Long</option>
                            <option value="SHORT">Short</option>
                        </select>
                        <select id="outcomeFilter">
                            <option value="">All Outcomes</option>
                            <option value="TP">Take Profit</option>
                            <option value="SL">Stop Loss</option>
                            <option value="MANUAL">Manual</option>
                        </select>
                        <input type="date" id="dateFromFilter" placeholder="From Date">
                        <input type="date" id="dateToFilter" placeholder="To Date">
                        <button class="btn" onclick="filterJournal()">Filter</button>
                    </div>
                    <div id="journalContent">
                        <p class="loading">Loading journal entries...</p>
                    </div>
                </div>
                
                <div id="statsTab" class="tab-content">
                    <div id="statsContent">
                        <p class="loading">Loading statistics...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="infoBlock" style="display: grid; grid-template-columns: 0.4fr 1fr; gap: 20px;">
            <div class="reactions-list">
                <h3>üìà Recent Reactions</h3>
                <div id="reactionsContent">
                    <p style="color: #a1a1aa;">No reactions to display</p>
                </div>
            </div>

            <div class="forex-calendar">
                <h3>üìÖ Forex Calendar & Event Impact</h3>
                <div class="calendar-grid">
                    <div class="todays-events">
                        <h4>Today's Events</h4>
                        <div id="todaysEvents">
                            <p class="loading">Loading today's events...</p>
                        </div>
                    </div>
                    <div class="upcoming-events">
                        <h4>High Impact Events (Next 24h)</h4>
                        <div id="upcomingEvents">
                            <p class="loading">Loading upcoming events...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for pair details -->
    <div id="pairModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Currency Pair Analysis</h2>
                <span class="close-btn" onclick="closePairModal()">&times;</span>
            </div>
            <div class="modal-tabs">
                <div class="modal-tab active" onclick="switchTab('stats')">Statistics</div>
                <div class="modal-tab" onclick="switchTab('calendar')">Calendar</div>
                <div class="modal-tab" onclick="switchTab('reactions')">Reactions</div>
            </div>
            <div id="pairStatsTab" class="tab-content active">
                <div id="pairStatsContent"></div>
            </div>
            <div id="pairCalendarTab" class="tab-content">
                <div id="pairCalendarContent"></div>
            </div>
            <div id="pairReactionsTab" class="tab-content">
                <div id="pairReactionsContent"></div>
            </div>
        </div>
    </div>
    
    <!-- Trade Form Modal -->
    <div id="tradeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Trade</h2>
                <span class="close-btn" onclick="closeTradeModal()">&times;</span>
            </div>
            <form id="tradeForm" class="trade-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Symbol</label>
                        <select id="tradeSymbol" required>
                            <option value="EURUSD">EURUSD</option>
                            <option value="GBPUSD">GBPUSD</option>
                            <option value="USDJPY">USDJPY</option>
                            <option value="AUDUSD">AUDUSD</option>
                            <option value="USDCAD">USDCAD</option>
                            <option value="NZDUSD">NZDUSD</option>
                            <option value="XAUUSD">XAUUSD</option>
                            <option value="DX-Y.NYB">DXY</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Trading Idea</label>
                        <select id="tradeIdea" required>
                            <option value="">Select or create new...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Direction</label>
                        <select id="tradeDirection" required>
                            <option value="LONG">Long</option>
                            <option value="SHORT">Short</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Entry Price (leave empty for current)</label>
                        <input type="number" id="tradeEntry" step="0.00001" placeholder="Current price">
                    </div>
                    <div class="form-group">
                        <label>Take Profit</label>
                        <input type="number" id="tradeTakeProfit" step="0.00001" required>
                    </div>
                    <div class="form-group">
                        <label>Stop Loss</label>
                        <input type="number" id="tradeStopLoss" step="0.00001" required>
                    </div>
                    <div class="form-group">
                        <label>Position Size</label>
                        <input type="number" id="tradeSize" step="0.01" value="1" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes (optional)</label>
                    <textarea id="tradeNotes" rows="3" placeholder="Trade rationale, setup details..."></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeTradeModal()" style="background: #6b7280;">Cancel</button>
                    <button type="submit" class="btn">Create Trade</button>
                </div>
            </form>
        </div>
    </div>

    <script>





        
        async function loadYesterdayLowEvents() {
            try {
                const response = await fetch('/api/yesterday-low-events');
                const events = await response.json();
                displayYesterdayLowEvents(events);
            } catch (error) {
                console.error('Error loading yesterday low events:', error);
            }
        }
        
        let yesterdayLowEvents = [];
        
        function displayYesterdayLowEvents(events) {
            if (!events || events.length === 0) return;
            
            // Clear existing yesterday low events to prevent duplicates
            yesterdayLowEvents = [];
            
            // Store yesterday low events for later sorting with deduplication
            const seenEvents = new Set();
            events.forEach(event => {
                const key = `${event.pair}_${event.breakTime}`;
                if (!seenEvents.has(key)) {
                    seenEvents.add(key);
                    yesterdayLowEvents.push({
                        ...event,
                        type: 'YESTERDAY_LOW',
                        timestamp: event.breakTime,
                        pair: event.pair,
                        fractalPrice: event.yesterdayLow,
                        breakPrice: event.triggerPrice
                    });
                }
            });
            
            // Trigger a re-display of all reactions with proper sorting
            displayAllReactions();
        }
        
        function displayAllReactions() {
            const reactionsContent = document.getElementById('reactionsContent');
            
            // Combine regular reactions and yesterday low events
            const allReactions = [];
            const seenKeys = new Set();
            
            // Add regular reactions if they exist
            if (window.currentReactions) {
                window.currentReactions.forEach(reaction => {
                    const key = `${reaction.pair}_${reaction.type}_${reaction.timestamp}`;
                    if (!seenKeys.has(key)) {
                        seenKeys.add(key);
                        allReactions.push(reaction);
                    }
                });
            }
            
            // Add yesterday low events with proper deduplication
            yesterdayLowEvents.forEach(event => {
                const key = `${event.pair}_YESTERDAY_LOW_${event.timestamp}`;
                if (!seenKeys.has(key)) {
                    seenKeys.add(key);
                    allReactions.push(event);
                }
            });
            
            if (allReactions.length === 0) {
                reactionsContent.innerHTML = '<p style="color: #a1a1aa;">No reactions to display</p>';
                return;
            }
            
            // Sort all reactions by timestamp (newest first)
            allReactions.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
            
            reactionsContent.innerHTML = allReactions.slice(0, 15).map(reaction => {
                if (reaction.type === 'YESTERDAY_LOW') {
                    return `
                        <div class="reaction-item yesterday-low">
                            <div class="reaction-header">
                                <span class="reaction-pair">${reaction.pair}</span>
                                <span class="yesterday-low-badge">YESTERDAY LOW</span>
                            </div>
                            <div style="font-size: 12px; color: #a1a1aa; margin-bottom: 10px;">
                                Break: ${new Date(reaction.breakTime).toLocaleString()} | 
                                Trigger: ${new Date(reaction.triggerTime).toLocaleString()} | 
                                Duration: ${reaction.duration}min
                            </div>
                            <div class="reaction-metrics">
                                <div class="metric">
                                    <div class="metric-label">Yesterday Low</div>
                                    <div class="metric-value">${reaction.yesterdayLow.toFixed(5)}</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label">Trigger Price</div>
                                    <div class="metric-value">${reaction.triggerPrice.toFixed(5)}</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label">Points Below</div>
                                    <div class="metric-value">${reaction.pointsBelow.toFixed(1)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="reaction-item">
                            <div class="reaction-header">
                                <span class="reaction-pair">${reaction.pair}</span>
                                <span class="reaction-type type-${reaction.type.toLowerCase()}">${reaction.type}</span>
                            </div>
                            <div style="font-size: 12px; color: #a1a1aa; margin-bottom: 10px;">
                                ${new Date(reaction.timestamp).toLocaleString()} | 
                                ${reaction.timeframe || 'Intraday'} | 
                                ID: ${reaction.id}
                            </div>
                            <div class="reaction-metrics">
                                <div class="metric">
                                    <div class="metric-label">Fractal Price</div>
                                    <div class="metric-value">${reaction.fractalPrice.toFixed(5)}</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label">Break Price</div>
                                    <div class="metric-value">${reaction.breakPrice.toFixed(5)}</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label">Price Diff</div>
                                    <div class="metric-value">${Math.abs(reaction.fractalPrice - reaction.breakPrice).toFixed(5)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }



        let currentPrices = {};
        let currentFractals = [];
        let priceUpdateInterval;
        let currentNews = [];
        let multiFractals = [];
        let activeTimeframe = 'daily';
        let brokenFractalsToday = new Set();
        let activeHoursInterval;
        let warningAlerts = new Set();
        let dailyMovements = {};
        
        async function loadCurrentFractals() {
            try {
                const response = await fetch('/api/current-fractals');
                currentFractals = await response.json();
                displayCurrentFractals();
            } catch (error) {
                console.error('Error loading fractals:', error);
            }
        }
        
        async function loadForexCalendar() {
            try {
                const [todaysResponse, upcomingResponse] = await Promise.all([
                    fetch('/api/todays-events'),
                    fetch('/api/upcoming-events')
                ]);
                
                const todaysEvents = await todaysResponse.json();
                const upcomingEvents = await upcomingResponse.json();
                
                currentNews = [...todaysEvents, ...upcomingEvents];
                
                displayTodaysEvents(todaysEvents);
                displayUpcomingEvents(upcomingEvents);
            } catch (error) {
                console.error('Error loading calendar:', error);
            }
        }
        
        function displayTodaysEvents(events) {
            const container = document.getElementById('todaysEvents');
            
            if (events.length === 0) {
                container.innerHTML = '<p class="loading">No events today</p>';
                return;
            }
            
            container.innerHTML = events.map(event => `
                <div class="event-item event-${event.impact.toLowerCase()}">
                    <div class="event-header">
                        <span class="event-title">${event.title}</span>
                        <span class="event-impact impact-${event.impact.toLowerCase()}">${event.impact}</span>
                    </div>
                    <div class="event-details">
                        <span class="event-time">${event.time}</span>
                        <span class="event-currency">${event.currency}</span>
                        <span style="margin-left: 8px;">${event.country}</span>
                    </div>
                    <div class="event-details" style="margin-top: 5px;">
                        Forecast: ${event.forecast} | Previous: ${event.previous}
                    </div>
                </div>
            `).join('');
        }
        
        function displayUpcomingEvents(events) {
            const container = document.getElementById('upcomingEvents');
            
            if (events.length === 0) {
                container.innerHTML = '<p class="loading">No high impact events in next 24h</p>';
                return;
            }
            
            container.innerHTML = events.map(event => {
                const eventDate = new Date(`${event.date}T${event.time}`);
                const timeUntil = Math.round((eventDate.getTime() - new Date().getTime()) / (1000 * 60 * 60));
                
                return `
                    <div class="event-item event-${event.impact.toLowerCase()}">
                        <div class="event-header">
                            <span class="event-title">${event.title}</span>
                            <span class="event-impact impact-${event.impact.toLowerCase()}">${event.impact}</span>
                        </div>
                        <div class="event-details">
                            <span class="event-time">In ${timeUntil}h</span>
                            <span class="event-currency">${event.currency}</span>
                            <span style="margin-left: 8px;">${event.country}</span>
                        </div>
                        <div class="event-details" style="margin-top: 5px;">
                            Forecast: ${event.forecast} | Previous: ${event.previous}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function updateCurrentPrices() {
            try {
                const response = await fetch('/api/current-prices');
                const newPrices = await response.json();
                
                // Check for breakouts
                checkForBreakouts(newPrices);
                
                currentPrices = newPrices;
                displayCurrentFractals();
            } catch (error) {
                console.error('Error updating prices:', error);
            }
        }
        
        let alertedPairs = new Set();
        
        function checkForBreakouts(newPrices) {
            for (const fractal of currentFractals) {
                const currentPrice = newPrices[fractal.pair];
                if (!currentPrice) continue;
                
                const highKey = `${fractal.pair}_HIGH_${fractal.high}`;
                const lowKey = `${fractal.pair}_LOW_${fractal.low}`;
                
                // Check for breakouts (original fractals)
                if (fractal.high && currentPrice > fractal.high && !brokenFractalsToday.has(highKey)) {
                    showAlert(fractal.pair, 'HIGH BROKEN', currentPrice.toFixed(5) + ' > ' + fractal.high.toFixed(5), 'breakout');
                    brokenFractalsToday.add(highKey);
                    markFractalAsBroken(fractal.pair, 'HIGH', fractal.high);
                    // Record breakout event
                    fetch('/api/record-breakout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pair: fractal.pair, type: 'HIGH', fractalPrice: fractal.high, breakPrice: currentPrice })
                    });
                }
                
                if (fractal.low && currentPrice < fractal.low && !brokenFractalsToday.has(lowKey)) {
                    showAlert(fractal.pair, 'LOW BROKEN', currentPrice.toFixed(5) + ' < ' + fractal.low.toFixed(5), 'breakout');
                    brokenFractalsToday.add(lowKey);
                    markFractalAsBroken(fractal.pair, 'LOW', fractal.low);
                    // Record breakout event
                    fetch('/api/record-breakout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pair: fractal.pair, type: 'LOW', fractalPrice: fractal.low, breakPrice: currentPrice })
                    });
                }
                
                // Check for proximity alerts (within 5 pips) - only for unbroken fractals
                const alertKey = `${fractal.pair}_proximity`;
                
                if (fractal.high && !brokenFractalsToday.has(highKey)) {
                    const pipsToHigh = Math.abs(calculatePips(fractal.pair, fractal.high, currentPrice));
                    if (pipsToHigh <= 5 && !alertedPairs.has(alertKey + '_high')) {
                        showAlert(fractal.pair, 'APPROACHING HIGH', pipsToHigh + ' pips away', 'proximity');
                        alertedPairs.add(alertKey + '_high');
                        setTimeout(function() { alertedPairs.delete(alertKey + '_high'); }, 300000);
                    }
                }
                
                if (fractal.low && !brokenFractalsToday.has(lowKey)) {
                    const pipsToLow = Math.abs(calculatePips(fractal.pair, currentPrice, fractal.low));
                    if (pipsToLow <= 5 && !alertedPairs.has(alertKey + '_low')) {
                        showAlert(fractal.pair, 'APPROACHING LOW', pipsToLow + ' pips away', 'proximity');
                        alertedPairs.add(alertKey + '_low');
                        setTimeout(function() { alertedPairs.delete(alertKey + '_low'); }, 300000);
                    }
                }
            }
        }
        
        function markFractalAsBroken(pair, type, price) {
            // Update the fractal display to show broken status
            const fractalIndex = currentFractals.findIndex(f => f.pair === pair);
            if (fractalIndex !== -1) {
                if (type === 'HIGH') {
                    currentFractals[fractalIndex].highBroken = true;
                    currentFractals[fractalIndex].brokenHighPrice = price;
                    // Find next higher fractal from weekly/monthly
                    const nextFractal = findNextHigherFractal(pair, 'HIGH', price);
                    if (nextFractal) {
                        currentFractals[fractalIndex].nextHigh = nextFractal.price;
                        currentFractals[fractalIndex].nextHighTimeframe = nextFractal.timeframe;
                        console.log(`üìà ${pair}: Next HIGH target: ${nextFractal.price.toFixed(5)} (${nextFractal.timeframe})`);
                    }
                } else {
                    currentFractals[fractalIndex].lowBroken = true;
                    currentFractals[fractalIndex].brokenLowPrice = price;
                    // Find next lower fractal from weekly/monthly
                    const nextFractal = findNextLowerFractal(pair, 'LOW', price);
                    if (nextFractal) {
                        currentFractals[fractalIndex].nextLow = nextFractal.price;
                        currentFractals[fractalIndex].nextLowTimeframe = nextFractal.timeframe;
                        console.log(`üìâ ${pair}: Next LOW target: ${nextFractal.price.toFixed(5)} (${nextFractal.timeframe})`);
                    }
                }
                displayCurrentFractals();
            }
        }
        
        function findNextHigherFractal(pair, type, brokenPrice) {
            const pairData = multiFractals.find(f => f.pair === pair);
            if (!pairData) return null;
            
            // Check weekly fractals first
            const weeklyHighs = pairData.weekly.highs.filter(f => f.status === 'ACTIVE' && f.price > brokenPrice);
            if (weeklyHighs.length > 0) {
                return { price: weeklyHighs[0].price, timeframe: 'weekly' };
            }
            
            // Then check monthly fractals
            const monthlyHighs = pairData.monthly.highs.filter(f => f.status === 'ACTIVE' && f.price > brokenPrice);
            if (monthlyHighs.length > 0) {
                return { price: monthlyHighs[0].price, timeframe: 'monthly' };
            }
            
            return null;
        }
        
        function findNextLowerFractal(pair, type, brokenPrice) {
            const pairData = multiFractals.find(f => f.pair === pair);
            if (!pairData) return null;
            
            // Check weekly fractals first
            const weeklyLows = pairData.weekly.lows.filter(f => f.status === 'ACTIVE' && f.price < brokenPrice);
            if (weeklyLows.length > 0) {
                return { price: weeklyLows[0].price, timeframe: 'weekly' };
            }
            
            // Then check monthly fractals
            const monthlyLows = pairData.monthly.lows.filter(f => f.status === 'ACTIVE' && f.price < brokenPrice);
            if (monthlyLows.length > 0) {
                return { price: monthlyLows[0].price, timeframe: 'monthly' };
            }
            
            return null;
        }
        
        function showAlert(pair, message, details, type) {
            // Create alert container if it doesn't exist
            let container = document.getElementById('alertContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'alertContainer';
                container.className = 'alert-container';
                document.body.appendChild(container);
            }
            
            const alert = document.createElement('div');
            alert.className = `alert-item alert-${type}`;
            
            const icon = type === 'breakout' ? 'üö®' : '‚ö†Ô∏è';
            alert.innerHTML = '<strong>' + icon + ' ' + pair + ' ' + message + '</strong><br>' + details;
            
            container.appendChild(alert);
            
            // Auto-remove after 5 seconds for breakouts, 10 seconds for proximity
            const duration = type === 'breakout' ? 5000 : 10000;
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, duration);
            
            // Play sound notification (optional)
            if (type === 'breakout') {
                playNotificationSound();
            }
        }
        
        function playNotificationSound() {
            // Create a simple beep sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }
        
        function displayCurrentFractals() {
            const fractalGrid = document.getElementById('fractalGrid');
            
            if (activeTimeframe === 'daily' && currentFractals.length === 0) {
                fractalGrid.innerHTML = '<p class="loading">No fractal data available</p>';
                return;
            }
            
            if (activeTimeframe !== 'daily') {
                displayMultiTimeframeFractals();
                return;
            }
            
            fractalGrid.innerHTML = currentFractals.map(fractal => {
                const currentPrice = currentPrices[fractal.pair];
                const pairData = multiFractals.find(f => f.pair === fractal.pair);
                
                // Get next targets from higher timeframes
                let nextHigh = null, nextLow = null;
                if (pairData && currentPrice) {
                    // Find next higher fractal high above current price
                    const allHighs = [...pairData.daily.highs, ...pairData.weekly.highs, ...pairData.monthly.highs]
                        .filter(f => f.status === 'ACTIVE' && f.price > currentPrice)
                        .sort((a, b) => a.price - b.price);
                    nextHigh = allHighs[0];
                    
                    // Find next lower fractal low below current price
                    const allLows = [...pairData.daily.lows, ...pairData.weekly.lows, ...pairData.monthly.lows]
                        .filter(f => f.status === 'ACTIVE' && f.price < currentPrice)
                        .sort((a, b) => b.price - a.price);
                    nextLow = allLows[0];
                }
                
                let highDistance = '';
                let lowDistance = '';
                let highClass = '';
                let lowClass = '';
                
                if (currentPrice && fractal.high) {
                    const pips = calculatePips(fractal.pair, fractal.high, currentPrice);
                    highDistance = `${pips > 0 ? '+' : ''}${pips} pips`;
                    if (fractal.highBroken) {
                        highClass = 'broken';
                        highDistance += ' (BROKEN)';
                    } else {
                        if (Math.abs(pips) <= 5) highClass = 'very-close';
                        else if (Math.abs(pips) <= 20) highClass = 'close';
                    }
                }
                
                if (currentPrice && fractal.low) {
                    const pips = calculatePips(fractal.pair, currentPrice, fractal.low);
                    lowDistance = `${pips > 0 ? '+' : '-'}${Math.abs(pips)} pips`;
                    if (fractal.lowBroken) {
                        lowClass = 'broken';
                        lowDistance += ' (BROKEN)';
                    } else {
                        if (Math.abs(pips) <= 5) lowClass = 'very-close';
                        else if (Math.abs(pips) <= 20) lowClass = 'close';
                    }
                }
                
                // Check for news impact
                const newsImpact = getNewsImpact(fractal.pair);
                const cardClass = newsImpact.hasHighImpact ? 'fractal-card high-impact' : 
                                 newsImpact.hasMediumImpact ? 'fractal-card news-impact' : 'fractal-card';
                
                return `
                    <div class="${cardClass}" onclick="openPairModal('${fractal.pair}')">
                        ${newsImpact.indicator}
                        <div class="fractal-pair">${fractal.pair}</div>
                        <div class="fractal-price price-change">
                            ${currentPrice ? currentPrice.toFixed(5) : 'Loading...'}
                            ${dailyMovements[fractal.pair] ? `<span style="font-size: 12px; margin-left: 8px; color: ${dailyMovements[fractal.pair].direction === 'UP' ? '#10b981' : dailyMovements[fractal.pair].direction === 'DOWN' ? '#ef4444' : '#a1a1aa'}">${dailyMovements[fractal.pair].direction === 'UP' ? '‚Üó' : dailyMovements[fractal.pair].direction === 'DOWN' ? '‚Üò' : '‚Üí'} ${dailyMovements[fractal.pair].changePercent.toFixed(2)}%</span>` : ''}
                        </div>
                        <div class="fractal-levels">
                            <div class="fractal-level fractal-high">
                                <div>Daily High</div>
                                <div>${pairData && pairData.daily.highs[0] ? pairData.daily.highs[0].price.toFixed(5) : 'None'}</div>
                                <div class="distance ${highClass}">${pairData && pairData.daily.highs[0] && currentPrice ? calculatePips(fractal.pair, pairData.daily.highs[0].price, currentPrice) + ' pips' + (pairData.daily.highs[0].status === 'BROKEN' ? ' (BROKEN)' : '') : ''}</div>
                                ${nextHigh ? `<div style="font-size: 10px; color: #10b981; margin-top: 4px;">Next Target: ${nextHigh.price.toFixed(5)} (${nextHigh.daysAgo}d ago)</div>` : ''}
                            </div>
                            <div class="fractal-level fractal-low">
                                <div>Daily Low</div>
                                <div>${pairData && pairData.daily.lows[0] ? pairData.daily.lows[0].price.toFixed(5) : 'None'}</div>
                                <div class="distance ${lowClass}">${pairData && pairData.daily.lows[0] && currentPrice ? calculatePips(fractal.pair, currentPrice, pairData.daily.lows[0].price) + ' pips' + (pairData.daily.lows[0].status === 'BROKEN' ? ' (BROKEN)' : '') : ''}</div>
                                ${nextLow ? `<div style="font-size: 10px; color: #ef4444; margin-top: 4px;">Next Target: ${nextLow.price.toFixed(5)} (${nextLow.daysAgo}d ago)</div>` : ''}
                            </div>
                        </div>
                        ${newsImpact.details}
                    </div>
                `;
            }).join('');
        }
        
        function displayMultiTimeframeFractals() {
            const fractalGrid = document.getElementById('fractalGrid');
            
            if (!multiFractals || multiFractals.length === 0) {
                fractalGrid.innerHTML = '<p class="loading">No multi-fractal data available</p>';
                return;
            }
            
            let html = '';
            
            multiFractals.forEach(pairData => {
                const fractals = pairData[activeTimeframe];
                const currentPrice = currentPrices[pairData.pair];
                
                // Get next active fractals (prioritize ACTIVE, fallback to first available)
                const nextHigh = fractals.highs.find(f => f.status === 'ACTIVE') || fractals.highs[0];
                const nextLow = fractals.lows.find(f => f.status === 'ACTIVE') || fractals.lows[0];
                
                let highDistance = '';
                let lowDistance = '';
                let highClass = '';
                let lowClass = '';
                
                if (currentPrice && nextHigh) {
                    const pips = calculatePips(pairData.pair, nextHigh.price, currentPrice);
                    highDistance = `${pips > 0 ? '+' : ''}${pips} pips`;
                    if (nextHigh.status === 'BROKEN') {
                        highClass = 'broken';
                        highDistance += ' (BROKEN)';
                    } else {
                        if (Math.abs(pips) <= 5) highClass = 'very-close';
                        else if (Math.abs(pips) <= 20) highClass = 'close';
                    }
                }
                
                if (currentPrice && nextLow) {
                    const pips = calculatePips(pairData.pair, currentPrice, nextLow.price);
                    lowDistance = `${pips > 0 ? '+' : '-'}${Math.abs(pips)} pips`;
                    if (nextLow.status === 'BROKEN') {
                        lowClass = 'broken';
                        lowDistance += ' (BROKEN)';
                    } else {
                        if (Math.abs(pips) <= 5) lowClass = 'very-close';
                        else if (Math.abs(pips) <= 20) lowClass = 'close';
                    }
                }
                
                // Check for news impact
                const newsImpact = getNewsImpact(pairData.pair);
                const cardClass = newsImpact.hasHighImpact ? 'fractal-card high-impact' : 
                                 newsImpact.hasMediumImpact ? 'fractal-card news-impact' : 'fractal-card';
                
                html += `
                    <div class="${cardClass}" onclick="openPairModal('${pairData.pair}')">
                        ${newsImpact.indicator}
                        <div class="fractal-pair">${pairData.pair}</div>
                        <div class="fractal-price price-change">
                            ${currentPrice ? currentPrice.toFixed(5) : 'Loading...'}
                        </div>
                        <div class="fractal-levels">
                            <div class="fractal-level fractal-high">
                                <div>Next ${activeTimeframe} High</div>
                                <div>${nextHigh ? nextHigh.price.toFixed(5) : 'None'}</div>
                                <div class="distance ${highClass}">${highDistance}</div>
                            </div>
                            <div class="fractal-level fractal-low">
                                <div>Next ${activeTimeframe} Low</div>
                                <div>${nextLow ? nextLow.price.toFixed(5) : 'None'}</div>
                                <div class="distance ${lowClass}">${lowDistance}</div>
                            </div>
                        </div>
                        <div class="multi-levels">`;
                        
                // Show additional levels
                const additionalHighs = fractals.highs.slice(1, 3);
                const additionalLows = fractals.lows.slice(1, 3);
                
                if (additionalHighs.length > 0) {
                    html += '<div style="font-size: 10px; color: #a1a1aa; margin-bottom: 2px;">Other Highs:</div>';
                    additionalHighs.forEach(f => {
                        const distance = currentPrice ? Math.abs(calculatePips(pairData.pair, f.price, currentPrice)) : 0;
                        html += `<div class="multi-level ${f.status.toLowerCase()}">${f.price.toFixed(5)} <span class="fractal-status ${f.status.toLowerCase()}">${f.status}</span> (${distance}p)</div>`;
                    });
                }
                
                if (additionalLows.length > 0) {
                    html += '<div style="font-size: 10px; color: #a1a1aa; margin-bottom: 2px; margin-top: 4px;">Other Lows:</div>';
                    additionalLows.forEach(f => {
                        const distance = currentPrice ? Math.abs(calculatePips(pairData.pair, currentPrice, f.price)) : 0;
                        html += `<div class="multi-level ${f.status.toLowerCase()}">${f.price.toFixed(5)} <span class="fractal-status ${f.status.toLowerCase()}">${f.status}</span> (${distance}p)</div>`;
                    });
                }
                
                html += `</div>
                        ${newsImpact.details}
                    </div>`;
            });
            
            fractalGrid.innerHTML = html;
        }
        
        function getNewsImpact(pair) {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            // Get currency from pair (first 3 chars for base, last 3 for quote)
            const baseCurrency = pair.substring(0, 3);
            const quoteCurrency = pair.substring(3, 6);
            
            let highImpactEvents = [];
            let mediumImpactEvents = [];
            
            currentNews.forEach(event => {
                if (event.currency === baseCurrency || event.currency === quoteCurrency) {
                    const eventTime = parseEventTime(event.time, event.date);
                    const timeDiff = Math.abs(currentTime - eventTime);
                    
                    // Check if event is happening now (within 30 minutes)
                    if (timeDiff <= 30) {
                        if (event.impact === 'HIGH') {
                            highImpactEvents.push(event);
                        } else if (event.impact === 'MEDIUM') {
                            mediumImpactEvents.push(event);
                        }
                    }
                }
            });
            
            let indicator = '';
            let details = '';
            
            if (highImpactEvents.length > 0) {
                indicator = '<div class="news-indicator high">HIGH</div>';
                const event = highImpactEvents[0];
                details = `<div class="news-details high">üì¢ ${event.title} (${event.currency}) - ${event.time}</div>`;
                return { hasHighImpact: true, hasMediumImpact: false, indicator, details };
            }
            
            if (mediumImpactEvents.length > 0) {
                indicator = '<div class="news-indicator">NEWS</div>';
                const event = mediumImpactEvents[0];
                details = `<div class="news-details">üì∞ ${event.title} (${event.currency}) - ${event.time}</div>`;
                return { hasHighImpact: false, hasMediumImpact: true, indicator, details };
            }
            
            return { hasHighImpact: false, hasMediumImpact: false, indicator: '', details: '' };
        }
        
        function parseEventTime(timeStr, dateStr) {
            if (timeStr === 'All Day') return 720; // 12:00 as default
            
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + (minutes || 0);
        }
        
        function calculatePips(pair, price1, price2) {
            let pipMultiplier;
            if (pair === 'USDJPY') pipMultiplier = 100;
            else if (pair === 'XAUUSD') pipMultiplier = 10;
            else if (pair === 'DX-Y.NYB') pipMultiplier = 100;
            else pipMultiplier = 10000;
            return Math.round((price1 - price2) * pipMultiplier);
        }
        
        function startPriceUpdates() {
            updateCurrentPrices();
            priceUpdateInterval = setInterval(updateCurrentPrices, 30000); // Update every 30 seconds
        }
        
        function stopPriceUpdates() {
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval);
            }
        }
        
        async function loadMultiFractals() {
            try {
                const response = await fetch('/api/multi-fractals');
                multiFractals = await response.json();
            } catch (error) {
                console.error('Error loading multi-fractals:', error);
            }
        }
        
        async function loadDailyMovements() {
            try {
                const pairs = ['EURUSD', 'GBPUSD', 'USDJPY', 'AUDUSD', 'USDCAD', 'NZDUSD', 'XAUUSD', 'DX-Y.NYB'];
                for (const pair of pairs) {
                    const response = await fetch(`/api/today-movement/${pair}`);
                    const movement = await response.json();
                    if (movement) {
                        dailyMovements[pair] = movement;
                    }
                }
            } catch (error) {
                console.error('Error loading daily movements:', error);
            }
        }
        
        function switchTimeframe(timeframe) {
            activeTimeframe = timeframe;
            document.querySelectorAll('.timeframe-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide appropriate content
            if (timeframe === 'journal') {
                document.getElementById('fractalGrid').style.display = 'none';
                document.getElementById('journalContainer').classList.add('active');
                loadJournalData();
            } else {
                document.getElementById('fractalGrid').style.display = 'grid';
                document.getElementById('journalContainer').classList.remove('active');
                displayCurrentFractals();
            }
        }
        
        // Trade Journal Functions
        let tradingIdeas = [];
        let openTrades = [];
        let journalEntries = [];
        let journalStats = {};
        
        async function loadJournalData() {
            await Promise.all([
                loadTradingIdeas(),
                loadOpenTrades(),
                loadJournalEntries(),
                loadJournalStats()
            ]);
            displayJournalStats();
            displayOpenTrades();
            displayJournalEntries();
        }
        
        async function loadTradingIdeas() {
            try {
                const response = await fetch('/api/trading-ideas');
                tradingIdeas = await response.json();
                updateIdeaSelects();
            } catch (error) {
                console.error('Error loading trading ideas:', error);
            }
        }
        
        async function loadOpenTrades() {
            try {
                const response = await fetch('/api/trades/open');
                openTrades = await response.json();
            } catch (error) {
                console.error('Error loading open trades:', error);
            }
        }
        
        async function loadJournalEntries() {
            try {
                const response = await fetch('/api/journal');
                journalEntries = await response.json();
            } catch (error) {
                console.error('Error loading journal entries:', error);
            }
        }
        
        async function loadJournalStats() {
            try {
                const response = await fetch('/api/stats');
                journalStats = await response.json();
            } catch (error) {
                console.error('Error loading journal stats:', error);
            }
        }
        
        function updateIdeaSelects() {
            const tradeIdeaSelect = document.getElementById('tradeIdea');
            const ideaFilterSelect = document.getElementById('ideaFilter');
            
            if (tradeIdeaSelect) {
                const currentValue = tradeIdeaSelect.value;
                tradeIdeaSelect.innerHTML = '<option value="">Select or create new...</option>';
                tradingIdeas.forEach(idea => {
                    tradeIdeaSelect.innerHTML += `<option value="${idea.id}">${idea.name}</option>`;
                });
                tradeIdeaSelect.innerHTML += '<option value="__new__">+ Create New Idea</option>';
                tradeIdeaSelect.value = currentValue;
            }
            
            if (ideaFilterSelect) {
                const currentValue = ideaFilterSelect.value;
                ideaFilterSelect.innerHTML = '<option value="">All Ideas</option>';
                tradingIdeas.forEach(idea => {
                    ideaFilterSelect.innerHTML += `<option value="${idea.id}">${idea.name}</option>`;
                });
                ideaFilterSelect.value = currentValue;
            }
        }
        
        function displayJournalStats() {
            document.getElementById('totalTrades').textContent = journalStats.totalTrades || 0;
            document.getElementById('winRate').textContent = (journalStats.winRate || 0).toFixed(1) + '%';
            document.getElementById('avgR').textContent = (journalStats.avgR || 0).toFixed(2);
            document.getElementById('expectancy').textContent = (journalStats.expectancy || 0).toFixed(2);
            document.getElementById('profitFactor').textContent = (journalStats.profitFactor || 0).toFixed(2);
        }
        
        function displayOpenTrades() {
            const container = document.getElementById('openTradesContent');
            
            if (openTrades.length === 0) {
                container.innerHTML = '<p style="color: #a1a1aa; text-align: center; padding: 40px;">No open trades</p>';
                return;
            }
            
            let html = `
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Idea</th>
                            <th>Direction</th>
                            <th>Entry</th>
                            <th>Current</th>
                            <th>TP</th>
                            <th>SL</th>
                            <th>Size</th>
                            <th>Unrealized PnL</th>
                            <th>R Multiple</th>
                            <th>Opened</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            openTrades.forEach(trade => {
                const idea = tradingIdeas.find(i => i.id === trade.ideaId);
                const pnlClass = (trade.unrealizedPnL || 0) >= 0 ? 'pnl-positive' : 'pnl-negative';
                const rClass = (trade.rMultiple || 0) >= 0 ? 'pnl-positive' : 'pnl-negative';
                
                html += `
                    <tr>
                        <td>${trade.symbol}</td>
                        <td>${idea ? idea.name : 'Unknown'}</td>
                        <td><span class="trade-direction direction-${trade.direction.toLowerCase()}">${trade.direction}</span></td>
                        <td>${trade.entryPrice.toFixed(5)}</td>
                        <td>${trade.currentPrice ? trade.currentPrice.toFixed(5) : 'Loading...'}</td>
                        <td>${trade.takeProfit.toFixed(5)}</td>
                        <td>${trade.stopLoss.toFixed(5)}</td>
                        <td>${trade.positionSize}</td>
                        <td class="${pnlClass}">${trade.unrealizedPnL ? trade.unrealizedPnL.toFixed(2) : '0.00'}</td>
                        <td class="${rClass}">${trade.rMultiple ? trade.rMultiple.toFixed(2) + 'R' : '0.00R'}</td>
                        <td>${new Date(trade.openedAt).toLocaleDateString()}</td>
                        <td>
                            <button class="btn" onclick="closeTrade('${trade.id}')" style="padding: 4px 8px; font-size: 0.75rem;">Close</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function displayJournalEntries() {
            const container = document.getElementById('journalContent');
            
            if (journalEntries.length === 0) {
                container.innerHTML = '<p style="color: #a1a1aa; text-align: center; padding: 40px;">No journal entries</p>';
                return;
            }
            
            let html = `
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Idea</th>
                            <th>Direction</th>
                            <th>Entry</th>
                            <th>Exit</th>
                            <th>Outcome</th>
                            <th>R Multiple</th>
                            <th>PnL</th>
                            <th>Hold Time</th>
                            <th>Closed</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            journalEntries.forEach(entry => {
                const idea = tradingIdeas.find(i => i.id === entry.ideaId);
                const pnlClass = entry.pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                const rClass = entry.rMultiple >= 0 ? 'pnl-positive' : 'pnl-negative';
                const holdTimeHours = Math.floor(entry.holdTime / 60);
                const holdTimeMinutes = entry.holdTime % 60;
                
                html += `
                    <tr>
                        <td>${entry.symbol}</td>
                        <td>${idea ? idea.name : 'Unknown'}</td>
                        <td><span class="trade-direction direction-${entry.direction.toLowerCase()}">${entry.direction}</span></td>
                        <td>${entry.entryPrice.toFixed(5)}</td>
                        <td>${entry.exitPrice.toFixed(5)}</td>
                        <td><span class="trade-outcome outcome-${entry.outcome.toLowerCase()}">${entry.outcome}</span></td>
                        <td class="${rClass}">${entry.rMultiple.toFixed(2)}R</td>
                        <td class="${pnlClass}">${entry.pnl.toFixed(2)}</td>
                        <td>${holdTimeHours}h ${holdTimeMinutes}m</td>
                        <td>${new Date(entry.closedAt).toLocaleDateString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function switchJournalTab(tab) {
            document.querySelectorAll('.journal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#journalContainer .tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            
            if (tab === 'open') {
                document.getElementById('openTradesTab').classList.add('active');
            } else if (tab === 'closed') {
                document.getElementById('closedTradesTab').classList.add('active');
            } else if (tab === 'stats') {
                document.getElementById('statsTab').classList.add('active');
                displayDetailedStats();
            }
        }
        
        function displayDetailedStats() {
            const container = document.getElementById('statsContent');
            // Implementation for detailed statistics by idea, time periods, etc.
            container.innerHTML = '<p>Detailed statistics coming soon...</p>';
        }
        
        async function openTradeForm() {
            document.getElementById('tradeModal').style.display = 'block';
            await loadTradingIdeas(); // Refresh ideas and update dropdown
        }
        
        function closeTradeModal() {
            document.getElementById('tradeModal').style.display = 'none';
            document.getElementById('tradeForm').reset();
        }
        
        async function filterJournal() {
            const params = new URLSearchParams();
            
            const ideaId = document.getElementById('ideaFilter').value;
            const direction = document.getElementById('directionFilter').value;
            const outcome = document.getElementById('outcomeFilter').value;
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;
            
            if (ideaId) params.append('ideaId', ideaId);
            if (direction) params.append('direction', direction);
            if (outcome) params.append('outcome', outcome);
            if (dateFrom) params.append('dateFrom', dateFrom);
            if (dateTo) params.append('dateTo', dateTo);
            
            try {
                const response = await fetch(`/api/journal?${params}`);
                journalEntries = await response.json();
                displayJournalEntries();
            } catch (error) {
                console.error('Error filtering journal:', error);
            }
        }
        
        async function closeTrade(tradeId) {
            const currentPrice = prompt('Enter exit price (leave empty for current market price):');
            const outcome = prompt('Enter outcome (TP/SL/MANUAL):', 'MANUAL');
            
            if (!outcome) return;
            
            try {
                const response = await fetch(`/api/trades/${tradeId}/close`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        exitPrice: currentPrice ? parseFloat(currentPrice) : null,
                        outcome: outcome.toUpperCase()
                    })
                });
                
                if (response.ok) {
                    await loadJournalData(); // Refresh all data
                } else {
                    alert('Error closing trade');
                }
            } catch (error) {
                console.error('Error closing trade:', error);
                alert('Error closing trade');
            }
        }
        
        // Trade form submission
        document.addEventListener('DOMContentLoaded', function() {
            const tradeForm = document.getElementById('tradeForm');
            if (tradeForm) {
                tradeForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    let ideaId = document.getElementById('tradeIdea').value;
                    
                    // Handle new idea creation
                    if (ideaId === '__new__') {
                        const ideaName = prompt('Enter new trading idea name:');
                        if (!ideaName) return;
                        
                        try {
                            const response = await fetch('/api/trading-ideas', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ name: ideaName })
                            });
                            const newIdea = await response.json();
                            ideaId = newIdea.id;
                            await loadTradingIdeas();
                        } catch (error) {
                            alert('Error creating trading idea');
                            return;
                        }
                    }
                    
                    const tradeData = {
                        symbol: document.getElementById('tradeSymbol').value,
                        ideaId: ideaId,
                        direction: document.getElementById('tradeDirection').value,
                        entryPrice: document.getElementById('tradeEntry').value ? parseFloat(document.getElementById('tradeEntry').value) : null,
                        takeProfit: parseFloat(document.getElementById('tradeTakeProfit').value),
                        stopLoss: parseFloat(document.getElementById('tradeStopLoss').value),
                        positionSize: parseFloat(document.getElementById('tradeSize').value),
                        notes: document.getElementById('tradeNotes').value
                    };
                    
                    try {
                        const response = await fetch('/api/trades', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(tradeData)
                        });
                        
                        if (response.ok) {
                            closeTradeModal();
                            await loadJournalData(); // Refresh data
                        } else {
                            const error = await response.json();
                            alert('Error creating trade: ' + error.error);
                        }
                    } catch (error) {
                        console.error('Error creating trade:', error);
                        alert('Error creating trade');
                    }
                });
            }
        });
        
        // Reset broken fractals at midnight
        function resetBrokenFractalsAtMidnight() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(now.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            const msUntilMidnight = tomorrow.getTime() - now.getTime();
            
            setTimeout(function() {
                brokenFractalsToday.clear();
                console.log('Reset broken fractals for new day');
                // Reset daily at midnight
                setInterval(function() {
                    brokenFractalsToday.clear();
                }, 24 * 60 * 60 * 1000);
            }, msUntilMidnight);
        }
        
        async function loadMomentumSessions() {
            try {
                const response = await fetch('/api/momentum-sessions');
                const data = await response.json();
                updateMomentumIndicator(data.status);
            } catch (error) {
                console.error('Error loading momentum sessions:', error);
            }
        }
        
        function updateMomentumIndicator(status) {
            const indicator = document.getElementById('momentumIndicator');
            if (indicator) {
                const now = new Date();
                const currentTime = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                
                // Check if waiting for session times
                const londonTime = '12:30';
                const nyTime = '15:30';
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const currentTotalMinutes = currentHour * 60 + currentMinute;
                const londonMinutes = 12 * 60 + 30;
                const nyMinutes = 15 * 60 + 30;
                
                let displayText = status;
                
                if (currentTotalMinutes < londonMinutes) {
                    const minutesUntilLondon = londonMinutes - currentTotalMinutes;
                    const hoursUntil = Math.floor(minutesUntilLondon / 60);
                    const minsUntil = minutesUntilLondon % 60;
                    displayText = `Waiting 12:30 London (${hoursUntil}h ${minsUntil}m) | ${currentTime}`;
                } else if (currentTotalMinutes < nyMinutes) {
                    const minutesUntilNY = nyMinutes - currentTotalMinutes;
                    const hoursUntil = Math.floor(minutesUntilNY / 60);
                    const minsUntil = minutesUntilNY % 60;
                    displayText = `Waiting 15:30 New York (${hoursUntil}h ${minsUntil}m) | ${currentTime}`;
                } else {
                    displayText = `${status} | ${currentTime}`;
                }
                
                indicator.textContent = displayText;
                
                if (status.includes('Active') || status.includes('high volatility')) {
                    indicator.style.color = '#10b981';
                    indicator.style.fontWeight = '700';
                } else {
                    indicator.style.color = '#f59e0b';
                    indicator.style.fontWeight = '500';
                }
            }
        }
        
        // Modal functions
        async function openPairModal(pair) {
            document.getElementById('modalTitle').textContent = pair + ' Analysis';
            document.getElementById('pairModal').style.display = 'block';
            await loadPairData(pair);
        }
        
        function closePairModal() {
            document.getElementById('pairModal').style.display = 'none';
        }
        
        function switchTab(tabName) {
            // Only affect modal tabs, not journal tabs
            document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#pairModal .tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show the selected tab content with unique pair prefix
            const targetTab = document.getElementById('pair' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
        }
        
        async function loadPairData(pair) {
            try {
                const [reactionsResponse, eventsResponse, movementsResponse] = await Promise.all([
                    fetch('/api/reactions?pair=' + pair),
                    fetch('/api/trading-stats'),
                    fetch('/api/daily-movements?pair=' + pair)
                ]);
                
                const reactionsData = await reactionsResponse.json();
                const allStats = await eventsResponse.json();
                const pairStats = allStats.find(s => s.pair === pair);
                const movements = await movementsResponse.json();
                
                displayPairStats(pair, reactionsData.stats, pairStats);
                displayPairCalendar(pair, movements);
                displayPairReactions(reactionsData.reactions);
            } catch (error) {
                console.error('Error loading pair data:', error);
            }
        }
        
        async function displayPairStats(pair, reactionStats, tradingStats) {
            const statsContent = document.getElementById('pairStatsContent');
            let statsHtml = '';
            
            // Load morning brief for major currencies
            const currencyMap = {
                'EURUSD': 'EUR', 'GBPUSD': 'GBP', 'USDJPY': 'JPY', 
                'AUDUSD': 'AUD', 'USDCAD': 'CAD', 'NZDUSD': 'NZD'
            };
            
            const currency = currencyMap[pair];
            if (currency) {
                try {
                    const briefResponse = await fetch(`/api/morning-brief/${currency}`);
                    const brief = await briefResponse.json();
                    if (brief && brief.note) {
                        const biasColor = brief.bias?.score > 0 ? '#10b981' : brief.bias?.score < 0 ? '#ef4444' : '#f59e0b';
                        const riskLevel = brief.calendar?.redLeft > 2 ? 'HIGH' : brief.calendar?.redLeft > 0 ? 'MEDIUM' : 'LOW';
                        const riskColor = riskLevel === 'HIGH' ? '#ef4444' : riskLevel === 'MEDIUM' ? '#f59e0b' : '#10b981';
                        const atrPips = brief.price?.atr14 ? (brief.price.atr14 * 10000).toFixed(1) : '0';
                        const range = brief.price?.yesterday ? ((brief.price.yesterday.high - brief.price.yesterday.low) * 10000).toFixed(1) : '0';
                        
                        statsHtml += `
                            <div style="background: rgba(59, 130, 246, 0.1); padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                                <h4 style="color: #3b82f6; margin-bottom: 12px;">üåÖ Morning Brief - ${brief.pair} (${brief.date})</h4>
                                <div style="font-size: 14px; line-height: 1.5; margin-bottom: 12px;">${brief.note}</div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; font-size: 12px;">
                                    <div class="tooltip"><strong>Bias:</strong> <span style="color: ${biasColor}">${brief.bias?.label || 'neutral'}</span><span class="tooltiptext">Overall directional sentiment: bullish (+), bearish (-), or neutral (0)</span></div>
                                    <div class="tooltip"><strong>Risk Level:</strong> <span style="color: ${riskColor}">${riskLevel}</span><span class="tooltiptext">Calendar risk based on high-impact events: HIGH (3+ events), MEDIUM (1-2 events), LOW (0 events)</span></div>
                                    <div class="tooltip"><strong>ATR14:</strong> ${atrPips}p<span class="tooltiptext">14-day Average True Range in pips - measures recent volatility</span></div>
                                    <div class="tooltip"><strong>Range:</strong> ${range}p<span class="tooltiptext">Yesterday's trading range (High - Low) in pips</span></div>
                                    <div class="tooltip"><strong>High:</strong> ${brief.price?.yesterday?.high?.toFixed(5) || 'N/A'}<span class="tooltiptext">Yesterday's session high price</span></div>
                                    <div class="tooltip"><strong>Low:</strong> ${brief.price?.yesterday?.low?.toFixed(5) || 'N/A'}<span class="tooltiptext">Yesterday's session low price</span></div>
                                    <div class="tooltip"><strong>Red Events:</strong> ${brief.calendar?.redLeft || 0}<span class="tooltiptext">Number of high-impact economic events scheduled today</span></div>
                                    <div class="tooltip"><strong>Asia Break:</strong> ${brief.price?.asiaBreak || 'none'}<span class="tooltiptext">Asia session breakout: 'high' (broke resistance), 'low' (broke support), 'none' (no break)</span></div>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.log(`No morning brief available for ${currency}`);
                }
            }
            
            statsHtml += '<div class="pair-stats-grid">';
            
            if (reactionStats) {
                statsHtml += `
                    <div class="pair-stat-card">
                        <div class="pair-stat-value">${reactionStats.count}</div>
                        <div class="pair-stat-label">Total Reactions</div>
                    </div>
                    <div class="pair-stat-card">
                        <div class="pair-stat-value">${reactionStats.followThroughRate}%</div>
                        <div class="pair-stat-label">Follow-through Rate</div>
                    </div>
                    <div class="pair-stat-card">
                        <div class="pair-stat-value">${reactionStats.avgImpulse15m}%</div>
                        <div class="pair-stat-label">Avg 15m Impulse</div>
                    </div>
                    <div class="pair-stat-card">
                        <div class="pair-stat-value">${reactionStats.avgImpulse1h}%</div>
                        <div class="pair-stat-label">Avg 1h Impulse</div>
                    </div>
                    <div class="pair-stat-card">
                        <div class="pair-stat-value">${reactionStats.avgMaxDrawdown}%</div>
                        <div class="pair-stat-label">Avg Max Drawdown</div>
                    </div>
                `;
            }
            
            if (tradingStats) {
                statsHtml += `
                    <div class="pair-stat-card">
                        <div class="pair-stat-value">${tradingStats.totalBreakouts}</div>
                        <div class="pair-stat-label">Total Breakouts</div>
                    </div>
                    <div class="pair-stat-card">
                        <div class="pair-stat-value">${tradingStats.longProbability.toFixed(1)}%</div>
                        <div class="pair-stat-label">Long Probability</div>
                    </div>
                    <div class="pair-stat-card">
                        <div class="pair-stat-value">${tradingStats.shortProbability.toFixed(1)}%</div>
                        <div class="pair-stat-label">Short Probability</div>
                    </div>
                `;
            }
            
            statsHtml += '</div>';
            if (!reactionStats && !tradingStats && pair !== 'EURUSD') {
                statsHtml += '<p style="color: #a1a1aa;">No statistics available for ' + pair + '</p>';
            }
            statsContent.innerHTML = statsHtml;
        }
        
        function displayPairCalendar(pair, movements) {
            const calendarContent = document.getElementById('pairCalendarContent');
            if (!movements || movements.length === 0) {
                calendarContent.innerHTML = '<p style="color: #a1a1aa;">No movement data available</p>';
                return;
            }
            
            const recent = movements.slice(-30); // Last 30 days
            let calendarHtml = `<h3>Daily Price Movements - ${pair}</h3><div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px;">`;
            
            recent.forEach(movement => {
                const date = new Date(movement.date);
                const dayName = date.toLocaleDateString('en', { weekday: 'short' });
                const dayNum = date.getDate();
                const color = movement.direction === 'UP' ? '#10b981' : movement.direction === 'DOWN' ? '#ef4444' : '#6b7280';
                const arrow = movement.direction === 'UP' ? '‚Üó' : movement.direction === 'DOWN' ? '‚Üò' : '‚Üí';
                
                calendarHtml += `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 8px; border-radius: 4px; text-align: center; border-left: 3px solid ${color};">
                        <div style="font-size: 10px; color: #a1a1aa;">${dayName}</div>
                        <div style="font-weight: bold;">${dayNum}</div>
                        <div style="color: ${color}; font-size: 12px;">${arrow} ${movement.changePercent.toFixed(1)}%</div>
                    </div>
                `;
            });
            
            calendarHtml += '</div>';
            calendarContent.innerHTML = calendarHtml;
        }
        
        function displayPairReactions(reactions) {
            const reactionsContent = document.getElementById('pairReactionsContent');

            if (!reactions || reactions.length === 0) {
                reactionsContent.innerHTML = '<p style="color: #a1a1aa;">No reaction data available</p>';
                return;
            }

            // Calculate price difference for each reaction
            const calculatePriceDiff = (reaction) => {
                const diff = Math.abs(reaction.fractalPrice - reaction.breakPrice);
                const percentage = ((diff / reaction.fractalPrice) * 100);
                return percentage;
            };

            let tableHtml = `
                <h3>Breakout Reactions (${reactions.length} events)</h3>
                <table class="events-table">
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Fractal Price</th>
                        <th>Break Price</th>
                        <th>Price Diff</th>
                        <th>Timeframe</th>
                        <th>ID</th>
                    </tr>
            `;

            reactions.forEach(reaction => {
                const dateTime = new Date(reaction.timestamp);
                const date = dateTime.toLocaleDateString();
                const time = dateTime.toLocaleTimeString();
                const priceDiff = calculatePriceDiff(reaction);
                
                tableHtml += `
                    <tr>
                        <td>${date}</td>
                        <td>${time}</td>
                        <td><span class="reaction-type type-${reaction.type.toLowerCase()}">${reaction.type}</span></td>
                        <td>${reaction.fractalPrice.toFixed(5)}</td>
                        <td>${reaction.breakPrice.toFixed(5)}</td>
                        <td>${priceDiff.toFixed(3)}%</td>
                        <td>${reaction.timeframe || 'Intraday'}</td>
                        <td style="font-size: 11px;">${reaction.id}</td>
                    </tr>
                `;
            });

            tableHtml += '</table>';
            reactionsContent.innerHTML = tableHtml;
        }
        
        // Load initial data
        window.onload = function() {
            loadForexCalendar();
            loadCurrentFractals();
            loadMultiFractals();
            loadDailyMovements();
            loadMomentumSessions();
            loadYesterdayLowEvents();
            startPriceUpdates();

            resetBrokenFractalsAtMidnight();
            
            // Update momentum sessions every minute
            setInterval(loadMomentumSessions, 60000);
            // Update time display every 30 seconds
            setInterval(() => updateMomentumIndicator(document.getElementById('momentumIndicator').textContent.split(' | ')[0] || 'Loading...'), 30000);
            // Update yesterday low events every 30 seconds
            setInterval(loadYesterdayLowEvents, 30000);
        };
        
        window.onclick = function(event) {
            const pairModal = document.getElementById('pairModal');
            const tradeModal = document.getElementById('tradeModal');
            if (event.target === pairModal) {
                closePairModal();
            }
            if (event.target === tradeModal) {
                closeTradeModal();
            }
        }
        
        // Stop updates when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopPriceUpdates();
            } else {
                startPriceUpdates();
            }
        });
    </script>
</body>
</html>